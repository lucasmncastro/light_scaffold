# ~/.autotest

module Autotest::GnomeNotify
  EXPIRATION_IN_SECONDS = 8
#  FAIL_IMAGE    = "gtk-dialog-error"
#  PENDING_IMAGE = "gtk-dialog-warning"
#  SUCCESS_IMAGE = "gtk-dialog-info"
  FAIL_IMAGE    = "~/Imagens/fail.png"
  PENDING_IMAGE = "~/Imagens/pending.png"
  SUCCESS_IMAGE = "~/Imagens/pass.png"

  def self.notify title, message, stock_icon
    options = "-t #{EXPIRATION_IN_SECONDS * 1000} -i #{stock_icon}"
    system "notify-send #{options} '#{title}' '#{message}'"
  end

  Autotest.add_hook :ran_command do |at|
    result = at.results.last
    if result
      examples = result =~ /(\d+) examples/ ? $1.to_i : 0
      failures = result =~ /(\d+) failure/ ? $1.to_i : 0
      pendings = result =~ /(\d+) pending/ ? $1.to_i : 0
      errors   = result =~ /(\d+) error/ ? $1.to_i : 0
      broken   = result !~ /(\d+) assertions/

      if broken
        notify "Qebrou Feio!", "Veja o console...", FAIL_IMAGE
      elsif errors > 0
        notify "Erros", "#{errors} error#{ errors == 1 ? ' encontrado' : 's encontrados' }.", FAIL_IMAGE
      elsif failures > 0
        notify "Testes Falharam", "#{failures} teste#{ failures == 1 ? ' falhou' : 's falharam' }.", FAIL_IMAGE
      elsif pendings > 0
        notify "Testes Pendentes", "#{pendings} teste#{ pendings == 1 ? ' pendente' : 's pendentes'}.", PENDING_IMAGE
      else 
        notify "Sucesso Total", "Uhu, todos os testes passaram!", SUCCESS_IMAGE
      end
    end
  end
end
